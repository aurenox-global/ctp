<!doctype html>
<html lang="es">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Calculadora de Planta El√©ctrica ‚Äì Consumo y Autonom√≠a</title>
		<meta name="description" content="App offline para calcular qu√© equipos pu							{ 													{ group: 'Otros', items: [
							{ id: 'pump', icon:'üö∞', motor:true, name: 'Bomba de agua', presets: { min: 200, med: 400, max: 750 }},
							{ id: 'pool', icon:'üèä', motor:true, name: 'Bomba de piscina', presets: { min: 400, med: 750, max: 1200 }},d: 'nas', icon:'üóÑÔ∏è', name: 'NAS/Servidor', presets: { min: 20, med: 40, max: 60 }},
							{ id: 'phone', icon:'üì±', name: 'Cargador smartphone', presets: { min: 5, med: 10, max: 18 }},
							{ id: 'prinj', icon:'üñ®Ô∏è', name: 'Impresora inkjet', presets: { min: 10, med: 20, max: 30 }}, 'laptop', icon:'üíª', name: 'Port√°til', presets: { min: 45, med: 60, max: 90 }},
							{ id: 'router', icon:'üì∂', name: 'Router/ONT', presets: { min: 6, med: 10, max: 15 }},
							{ id: 'switch', icon:'üîÅ', name: 'Switch (no PoE)', presets: { min: 3, med: 7, max: 12 }},
							{ id: 'switchpoe', icon:'üîå', name: 'Switch PoE 8p', presets: { min: 30, med: 60, max: 100 }}, conectar a una planta el√©ctrica y por cu√°ntas horas, con categor√≠as m√≠nimo/medio/m√°ximo por equipo." />
		<style>
			:root {
				--bg: #0b0c10;
				--surface: #14151b;
				--text: #e8e8ea;
				--muted: #b7b7c2;
				--primary: #6de19b;
				--primary-contrast: #0b3d27;
				--danger: #ff6b6b;
				--warn: #ffd166;
				--ok: #2dd4bf;
				--border: #2a2d36;
				--chip: #1d1f28;
				--shadow: 0 10px 30px rgba(0,0,0,.35);
			}
			[data-theme="light"] {
				--bg: #f7f7fb;
				--surface: #ffffff;
				--text: #1f2430;
				--muted: #5a6275;
				--primary: #0ea5e9;
				--primary-contrast: #062e49;
				--danger: #e11d48;
				--warn: #b45309;
				--ok: #059669;
				--border: #e6e6f0;
				--chip: #f1f5f9;
				--shadow: 0 10px 30px rgba(31,36,48,.12);
			}

			* { box-sizing: border-box; }
			html, body { height: 100%; }
			body {
				margin: 0;
				background: var(--bg);
				color: var(--text);
				font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
				line-height: 1.35;
			}
					header {
				position: sticky; top: 0; z-index: 10;
						-webkit-backdrop-filter: saturate(120%) blur(6px);
						backdrop-filter: saturate(120%) blur(6px);
				background: color-mix(in srgb, var(--bg) 85%, transparent);
				border-bottom: 1px solid var(--border);
			}
			.wrap { max-width: 1100px; margin: 0 auto; padding: 12px 16px; }
			.row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
			.spacer { flex: 1; }
			.title { font-size: 16px; font-weight: 700; letter-spacing: .2px; }
			.btn {
				appearance: none; border: 1px solid var(--border); background: var(--surface); color: var(--text);
				padding: 8px 12px; border-radius: 10px; cursor: pointer; box-shadow: var(--shadow);
			}
			.btn.primary { background: var(--primary); color: white; border-color: transparent; }
			.btn.ghost { background: transparent; }
			.btn.small { padding: 6px 10px; border-radius: 8px; }
			.btn:disabled { opacity: .5; cursor: not-allowed; }

			main { padding: 18px 16px 80px; max-width: 1100px; margin: 0 auto; }
			.card {
				background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: var(--shadow);
			}
			.grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
			.col-12 { grid-column: span 12; }
			.col-6 { grid-column: span 6; }
			.col-4 { grid-column: span 4; }
			.col-3 { grid-column: span 3; }
			.col-2 { grid-column: span 2; }
			@media (max-width: 920px) {
				.col-6, .col-4, .col-3, .col-2 { grid-column: span 12; }
			}

			.field { display: grid; gap: 6px; }
			.field label { font-size: 12px; color: var(--muted); }
			.field input[type="number"], .field select, .field input[type="text"] {
				width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text);
			}
			.inline { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
			.between { justify-content: space-between; }
			.flex-1 { flex: 1; }
			.w110 { width: 110px; }
			.muted { color: var(--muted); font-size: 12px; }
			.chip { background: var(--chip); padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); }

			/* Tabla responsive */
			.table { width: 100%; display: grid; gap: 10px; }
			.t-head, .t-row { display: grid; grid-template-columns: 2fr 130px 110px 120px 120px; gap: 8px; align-items: center; }
			.t-head { font-size: 12px; color: var(--muted); padding: 2px 6px; }
			.t-row { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 8px; }
			.t-row strong { font-weight: 600; }
			.t-row .icon { font-size: 20px; margin-right: 8px; }
			.subctrl { margin-top: 6px; display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); }
			.subctrl input[type="checkbox"] { width: 16px; height: 16px; }
			.t-row input[type="number"], .t-row select { padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
			.t-row .right { text-align: right; }
			@media (max-width: 780px) {
				.t-head { display: none; }
				.t-row { grid-template-columns: 1fr 1fr; row-gap: 8px; }
				.t-row > .name { grid-column: 1 / -1; font-weight: 700; }
				.t-row > .qty, .t-row > .preset { grid-column: span 1; }
				.t-row > .watt, .t-row > .max { grid-column: span 1; text-align: right; }
			}

			.section-title { margin: 8px 2px 6px; font-size: 14px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: .4px; }

			.progress {
				height: 10px; background: var(--chip); border-radius: 999px; border: 1px solid var(--border); overflow: hidden; position: relative;
			}
			.progress > span { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: var(--ok); transition: width .2s ease; }
			.progress[data-state="warn"] > span { background: var(--warn); }
			.progress[data-state="danger"] > span { background: var(--danger); }
					.subline { margin-top: 8px; font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 8px; }
					.stack { display: grid; gap: 8px; }

			footer { position: sticky; bottom: 0; background: color-mix(in srgb, var(--bg) 92%, transparent); border-top: 1px solid var(--border); }
			.footer-wrap { max-width: 1100px; margin: 0 auto; padding: 10px 16px; display: grid; gap: 8px; }
			.summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
			@media (max-width: 820px) { .summary { grid-template-columns: 1fr; } }

			.note { font-size: 12px; color: var(--muted); }
			.danger { color: var(--danger); }
			.success { color: var(--ok); }
		</style>
	</head>
	<body>
		<header>
			<div class="wrap row">
				<div class="title">‚ö° Calculadora de Planta El√©ctrica</div>
				<div class="spacer"></div>
				<button id="themeToggle" class="btn small ghost" aria-label="Cambiar tema">üåì Tema</button>
				<button id="resetBtn" class="btn small ghost" aria-label="Reiniciar">‚Ü∫ Reiniciar</button>
				<button id="exportBtn" class="btn small" aria-label="Exportar">‚¨áÔ∏é Exportar</button>
				<button id="importBtn" class="btn small" aria-label="Importar">‚¨ÜÔ∏é Importar</button>
			</div>
		</header>

		<main>
			<section class="grid">
				<div class="col-12 card">
					<div class="grid">
						<div class="col-4 field">
							<label for="plantPower">Potencia m√°xima de la planta (W)</label>
							<input type="number" id="plantPower" min="0" inputmode="numeric" placeholder="Ej. 600" />
							<div class="muted">L√≠mite de potencia instant√°nea. Sugerido usar 70‚Äì80% para operaci√≥n continua.</div>
						</div>
						<div class="col-4 field">
							<label>Energ√≠a disponible (opcional)</label>
											<div class="inline">
												<input type="number" id="energyValue" min="0" step="0.1" placeholder="Ej. 2" class="flex-1" />
												<select id="energyUnit" class="w110" aria-label="Unidad">
									<option value="kWh">kWh</option>
									<option value="Wh">Wh</option>
								</select>
							</div>
							<div class="muted">Para estimar horas de autonom√≠a cuando todos los equipos seleccionados funcionan a la vez.</div>
						</div>
						<div class="col-4 field">
							<label for="safety">Margen de seguridad (%)</label>
							<input type="number" id="safety" min="50" max="100" step="1" />
							<div class="muted">Por defecto 80%. La potencia utilizable ser√° Planta √ó Margen.</div>
						</div>
									<div class="col-6 field">
										<label for="surgeMode">Pico de arranque (motores)</label>
										<div class="inline">
											<select id="surgeMode" aria-label="Modo de pico" class="flex-1">
												<option value="none">Sin considerar pico</option>
												<option value="largest">Pico del mayor motor</option>
												<option value="all">Pico simult√°neo (conservador)</option>
											</select>
											<input type="number" id="surgeFactor" min="1" step="0.1" class="w110" placeholder="3" />
										</div>
										<div class="muted">Se aplicar√° el factor a equipos con motor: ventiladores, bombas, nevera, A/A, lavadora, etc.</div>
									</div>
									<div class="col-6 field">
										<label>Perfiles r√°pidos</label>
										<div class="inline">
											<button id="profileEssential" class="btn small">Esencial</button>
											<button id="profileFull" class="btn small">Completo</button>
											<button id="profileClear" class="btn small ghost">Limpiar cantidades</button>
										</div>
										<div class="muted">Rellena cantidades t√≠picas para empezar. Puedes ajustar luego.</div>
									</div>
					</div>
				</div>

				<div class="col-12">
					<div id="deviceContainer"></div>
				</div>

						<div class="col-12 card">
					<div class="section-title">A√±adir equipo personalizado</div>
					<div class="grid">
								<div class="col-3 field"><label>Nombre</label><input id="customName" type="text" placeholder="Ej. Proyector" /></div>
								<div class="col-2 field"><label>Icono (emoji)</label><input id="customIcon" type="text" placeholder="üìΩÔ∏è" /></div>
								<div class="col-2 field"><label class="muted">Motor</label><div class="subctrl"><label><input type="checkbox" id="customMotor" /> Aplica pico</label></div></div>
								<div class="col-2 field"><label>M√≠n (W)</label><input id="customMin" type="number" min="0" placeholder="Ej. 50" /></div>
								<div class="col-2 field"><label>Medio (W)</label><input id="customMed" type="number" min="0" placeholder="Ej. 100" /></div>
								<div class="col-1 field"><label>M√°x (W)</label><input id="customMax" type="number" min="0" placeholder="150" /></div>
						<div class="col-12 inline">
							<button id="addCustom" class="btn primary">Agregar</button>
							<span class="muted">Se guarda localmente y aparecer√° en la secci√≥n ‚ÄúPersonalizados‚Äù.</span>
						</div>
					</div>
				</div>
			</section>
		</main>

		<footer>
			<div class="footer-wrap">
				<div class="summary">
								<div class="card">
									<div class="inline between">
										<strong>Potencia utilizada</strong>
										<span id="powerPct" class="chip">0%</span>
									</div>
									<div class="stack">
										<div class="progress" id="powerProgress"><span></span></div>
										<div class="subline"><span>Continuo:</span><span id="powerDetail">0 W de 0 W disponibles</span></div>
										<div class="progress" id="surgeProgress"><span></span></div>
										<div class="subline"><span>Pico estimado:</span><span id="surgeDetail">‚Äî</span></div>
									</div>
								</div>
					<div class="card">
									<div class="inline between">
							<strong>Autonom√≠a estimada</strong>
							<span class="chip" id="runtimeChip">‚Äî</span>
						</div>
						<div class="note" id="runtimeNote">Ingresa energ√≠a disponible para calcular horas.</div>
					</div>
					<div class="card">
									<div class="inline between">
							<strong>Estado</strong>
							<span class="chip" id="statusChip">Configura tu planta</span>
						</div>
						<div class="note">Consejo: evita sobrepasar el {<span id="safePct">80</span>%} de carga continua.</div>
					</div>
				</div>
				<div class="note">Aviso: los valores son referenciales. Algunos equipos con motor (nevera, bomba, aire) tienen picos de arranque superiores al consumo nominal.</div>
			</div>
		</footer>

		<script>
			// Estado y datos
			const KEY = 'power-app-state-v1';
			const THEME_KEY = 'power-app-theme';

							const DEFAULT_DEVICES = [
						{ group: 'Iluminaci√≥n', items: [
									{ id: 'led', icon:'üí°', name: 'Bombillo LED', presets: { min: 1, med: 5, max: 10 }},
									{ id: 'tiraled', icon:'üßµ', name: 'Tira LED', presets: { min: 5, med: 10, max: 20 }},
									{ id: 'focoext', icon:'üî¶', name: 'Foco exterior', presets: { min: 10, med: 20, max: 30 }},
						]},
						{ group: 'Clima y ventilaci√≥n', items: [
									{ id: 'fan', icon:'üåÄ', motor:true, name: 'Ventilador', presets: { min: 20, med: 40, max: 60 }},
									{ id: 'evap', icon:'üíß', motor:true, name: 'Enfriador evaporativo', presets: { min: 60, med: 100, max: 160 }},
									{ id: 'dehum', icon:'üå´Ô∏è', motor:true, name: 'Deshumidificador', presets: { min: 200, med: 300, max: 500 }},
									{ id: 'ac', icon:'‚ùÑÔ∏è', motor:true, name: 'Aire port√°til', presets: { min: 600, med: 900, max: 1200 }},
						]},
								{ group: 'Cocina', items: [
									{ id: 'micro', icon:'üç≤', name: 'Microondas', presets: { min: 700, med: 1000, max: 1200 }},
							{ id: 'coff', icon:'‚òï', name: 'Cafetera', presets: { min: 600, med: 1000, max: 1500 }},
							{ id: 'airfry', icon:'üçü', name: 'Freidora de aire', presets: { min: 1200, med: 1500, max: 2000 }},
							{ id: 'kettle', icon:'ü´ñ', name: 'Hervidor de agua', presets: { min: 1200, med: 1800, max: 2200 }},
							{ id: 'toaster', icon:'üçû', name: 'Tostadora', presets: { min: 700, med: 900, max: 1200 }},
							{ id: 'horno', icon:'üç™', name: 'Horno el√©ctrico', presets: { min: 1000, med: 1500, max: 2000 }},
							{ id: 'licua', icon:'ü•§', name: 'Licuadora', presets: { min: 200, med: 400, max: 800 }},
						]},
						{ group: 'Limpieza', items: [
									{ id: 'asp', icon:'üßπ', motor:true, name: 'Aspiradora', presets: { min: 400, med: 800, max: 1200 }},
									{ id: 'wash', icon:'üß∫', motor:true, name: 'Lavadora', presets: { min: 300, med: 500, max: 800 }},
												{ id: 'dryer', icon:'üß¶', name: 'Secadora el√©ctrica', presets: { min: 1000, med: 1500, max: 2000 }},
												{ id: 'iron', icon:'üëï', name: 'Plancha', presets: { min: 1000, med: 1500, max: 2000 }},
						]},
						{ group: 'Electr√≥nica', items: [
							{ id: 'tv', icon:'üì∫', name: 'TV', presets: { min: 50, med: 100, max: 150 }},
							{ id: 'monitor', icon:'üñ•Ô∏è', name: 'Monitor', presets: { min: 20, med: 35, max: 50 }},
												{ id: 'pc', icon:'‚å®Ô∏è', name: 'PC escritorio', presets: { min: 120, med: 200, max: 350 }},
							{ id: 'pcgamer', icon:'üéÆ', name: 'PC gamer', presets: { min: 300, med: 500, max: 750 }},
							{ id: 'console', icon:'üïπÔ∏è', name: 'Consola', presets: { min: 80, med: 150, max: 220 }},
							{ id: 'projector', icon:'üìΩÔ∏è', name: 'Proyector', presets: { min: 70, med: 120, max: 200 }},
							{ id: 'laptop', icon:'üíª', name: 'Port√°til', presets: { min: 45, med: 60, max: 90 }},
												{ id: 'router', icon:'ÔøΩ', name: 'Router/ONT', presets: { min: 6, med: 10, max: 15 }},
												{ id: 'switch', icon:'ÔøΩ', name: 'Switch (no PoE)', presets: { min: 3, med: 7, max: 12 }},
							{ id: 'switchpoe', icon:'üîå', name: 'Switch PoE 8p', presets: { min: 30, med: 60, max: 100 }},
							{ id: 'cam', icon:'üì∑', name: 'C√°mara PoE (c/u)', presets: { min: 3, med: 6, max: 10 }},
							{ id: 'nvr', icon:'üíæ', name: 'NVR / DVR', presets: { min: 15, med: 30, max: 50 }},
							{ id: 'nas', icon:'üóÑÔ∏è', name: 'NAS/Servidor', presets: { min: 20, med: 40, max: 60 }},
												{ id: 'phone', icon:'ÔøΩ', name: 'Cargador smartphone', presets: { min: 5, med: 10, max: 18 }},
							{ id: 'prinj', icon:'üñ®Ô∏è', name: 'Impresora inkjet', presets: { min: 10, med: 20, max: 30 }},
							{ id: 'prlaser', icon:'üñ®Ô∏è', name: 'Impresora l√°ser', presets: { min: 300, med: 500, max: 900 }},
						]},
						{ group: 'Otros', items: [
												{ id: 'pump', icon:'ÔøΩ', motor:true, name: 'Bomba de agua', presets: { min: 200, med: 400, max: 750 }},
									{ id: 'pool', icon:'üèä', motor:true, name: 'Bomba de piscina', presets: { min: 400, med: 750, max: 1200 }},
									{ id: 'garage', icon:'üö™', motor:true, name: 'Puerta de garaje', presets: { min: 300, med: 500, max: 800 }},
									{ id: 'fridge', icon:'üßä', motor:true, name: 'Nevera', presets: { min: 70, med: 150, max: 300 }},
							{ id: 'hair', icon:'üíà', name: 'Secador de pelo', presets: { min: 500, med: 1000, max: 1500 }},
							{ id: 'usbhub', icon:'üîã', name: 'Cargador USB m√∫ltiple', presets: { min: 10, med: 25, max: 45 }},
						]},
					];

					const templateState = () => ({
				plantPower: 600,
				safety: 80,
				energyValue: 2,
				energyUnit: 'kWh',
						surgeMode: 'none',
						surgeFactor: 3,
				devices: {}, // id -> {preset: 'min'|'med'|'max', qty: number}
				custom: [], // {id,name,presets}
			});

			let state = loadState();
			let eventsAttached = false;

			function loadState() {
				try {
					const raw = localStorage.getItem(KEY);
					if (raw) return JSON.parse(raw);
				} catch {}
				return templateState();
			}
			function saveState() { localStorage.setItem(KEY, JSON.stringify(state)); }

			// Tema
			function applyTheme() {
				const theme = localStorage.getItem(THEME_KEY) || 'dark';
				document.documentElement.setAttribute('data-theme', theme);
			}
			function toggleTheme(){
				const current = document.documentElement.getAttribute('data-theme') || 'dark';
				const next = current === 'dark' ? 'light' : 'dark';
				localStorage.setItem(THEME_KEY, next); applyTheme();
			}
			applyTheme();

			// UI Init
			const el = {
				plantPower: document.getElementById('plantPower'),
				energyValue: document.getElementById('energyValue'),
				energyUnit: document.getElementById('energyUnit'),
				safety: document.getElementById('safety'),
				deviceContainer: document.getElementById('deviceContainer'),
				powerDetail: document.getElementById('powerDetail'),
						surgeDetail: document.getElementById('surgeDetail'),
				powerPct: document.getElementById('powerPct'),
				powerProgress: document.getElementById('powerProgress'),
						surgeProgress: document.getElementById('surgeProgress'),
				runtimeChip: document.getElementById('runtimeChip'),
				runtimeNote: document.getElementById('runtimeNote'),
				statusChip: document.getElementById('statusChip'),
				safePct: document.getElementById('safePct'),
						surgeMode: document.getElementById('surgeMode'),
						surgeFactor: document.getElementById('surgeFactor'),
			};

			document.getElementById('themeToggle').addEventListener('click', toggleTheme);
			document.getElementById('resetBtn').addEventListener('click', () => {
				if (!confirm('¬øReiniciar configuraci√≥n y cantidades?')) return;
				state = templateState();
				saveState();
				renderAll();
			});

			document.getElementById('exportBtn').addEventListener('click', () => {
				const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a'); a.href = url; a.download = 'planta-config.json'; a.click();
				setTimeout(() => URL.revokeObjectURL(url), 1000);
			});
			document.getElementById('importBtn').addEventListener('click', () => {
				const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
				inp.onchange = () => {
					const file = inp.files[0]; if (!file) return;
					file.text().then(t => { state = JSON.parse(t); saveState(); renderAll(); });
				};
				inp.click();
			});

			function toWh(value, unit){ return unit === 'kWh' ? value * 1000 : value; }
			function fmt(x){ return new Intl.NumberFormat('es-ES').format(x); }
			function fmt1(x){ return new Intl.NumberFormat('es-ES', {maximumFractionDigits:1}).format(x); }
			function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

							function makeRow(item){
				const id = item.id;
								const config = state.devices[id] || { preset: 'med', qty: 0 };
				const selW = item.presets[config.preset];
				const row = document.createElement('div'); row.className='t-row'; row.dataset.id=id;
						const icon = item.icon || 'üß©';
						row.innerHTML = `
							<div class="name"><span class="icon" aria-hidden="true">${icon}</span><strong>${item.name}</strong><div class="muted">M√≠n ${item.presets.min}W ¬∑ Med ${item.presets.med}W ¬∑ M√°x ${item.presets.max}W</div></div>
									<div class="preset"><select aria-label="Preset">
						<option value="min">M√≠n (${item.presets.min}W)</option>
						<option value="med">Med (${item.presets.med}W)</option>
						<option value="max">M√°x (${item.presets.max}W)</option>
									</select>
									<div class="subctrl">
										<label><input type="checkbox" class="motorCheck" /> Motor</label>
									</div>
									</div>
					<div class="qty"><input type="number" min="0" step="1" aria-label="Cantidad" /></div>
					<div class="watt right"><span class="chip">0 W</span></div>
					<div class="max right"><span class="muted">M√°x: ‚Äî</span></div>
				`;
				const presetSel = row.querySelector('select'); presetSel.value = config.preset;
				const qtyInp = row.querySelector('input[type="number"]'); qtyInp.value = config.qty;
				const motorChk = row.querySelector('.motorCheck');
				const effectiveMotor = (config && Object.prototype.hasOwnProperty.call(config,'motor')) ? !!config.motor : !!item.motor;
				motorChk.checked = effectiveMotor;

				function update(){
					const preset = presetSel.value; const watt = item.presets[preset];
					const qty = Number(qtyInp.value)||0; const used = watt * qty;
					row.querySelector('.watt .chip').textContent = `${fmt(used)} W`;
					const utilW = usablePower();
					const maxUnits = utilW>0? Math.floor(utilW / watt) : 0;
					row.querySelector('.max .muted').textContent = `M√°x con planta: ${fmt(maxUnits)}`;
									state.devices[id] = { preset, qty, motor: !!motorChk.checked };
					saveState();
					recalc();
				}
				presetSel.addEventListener('change', update);
				qtyInp.addEventListener('input', update);
								motorChk.addEventListener('change', update);
				// Inicial
				update();
				return row;
			}

			function renderDevices(){
				const container = el.deviceContainer; container.innerHTML = '';
				const allGroups = [...DEFAULT_DEVICES];
				if (state.custom && state.custom.length){ allGroups.push({group: 'Personalizados', items: state.custom}); }

				for (const g of allGroups){
					const block = document.createElement('div'); block.className='card';
					const title = document.createElement('div'); title.className='section-title'; title.textContent = g.group;
					block.appendChild(title);
					const table = document.createElement('div'); table.className='table';
					const head = document.createElement('div'); head.className='t-head'; head.innerHTML = '<div>Equipo</div><div>Modo</div><div>Cant.</div><div class="right">W usados</div><div class="right">Capacidad</div>';
					table.appendChild(head);
					for (const item of g.items){ table.appendChild(makeRow(item)); }
					block.appendChild(table);
					container.appendChild(block);
				}
			}

			function usablePower(){
				const p = Number(el.plantPower.value)||0; const s = clamp(Number(el.safety.value)||80, 1, 100);
				return Math.floor(p * (s/100));
			}

					function recalc(){
				const utilW = usablePower();
				let totalW = 0;
						let motorContrib = []; // watts de cada motor (ya multiplicado por cantidad?)
				// sumar filas
				for (const [id, cfg] of Object.entries(state.devices)){
					// buscar preset
					const item = findItemById(id);
					if (!item) continue;
					const w = (item.presets[cfg.preset]||0);
					const qty = (Number(cfg.qty)||0);
					totalW += w * qty;
					// Usar el estado del motor guardado, no el del item original
					const isMotor = (cfg && Object.prototype.hasOwnProperty.call(cfg,'motor')) ? !!cfg.motor : !!item.motor;
					if (isMotor && qty>0) {
						for (let i=0;i<qty;i++) motorContrib.push(w); // cada unidad posible pico
					}
				}

				// UI potencia
				if (el.powerDetail) el.powerDetail.textContent = `${fmt(totalW)} W de ${fmt(utilW)} W disponibles`;
				const pct = utilW>0? clamp(Math.round((totalW/utilW)*100), 0, 999) : 0;
				if (el.powerPct) el.powerPct.textContent = `${pct}%`;
				const bar = el.powerProgress && el.powerProgress.querySelector('span');
				if (bar) {
					el.powerProgress.dataset.state = pct<85? 'ok' : (pct<=100? 'warn' : 'danger');
					bar.style.width = `${clamp(pct,0,100)}%`;
				}

				// Estado se maneja m√°s abajo con el pico

						// Autonom√≠a por energ√≠a
				const eVal = Number(el.energyValue.value)||0; const eUnit = el.energyUnit.value;
				const wh = toWh(eVal, eUnit);
				el.safePct.textContent = String(clamp(Number(el.safety.value)||80,1,100));
				if (wh>0 && totalW>0){
					const hours = wh / totalW; // funcionamiento simult√°neo
					el.runtimeChip.textContent = `${fmt1(hours)} h`;
					el.runtimeNote.textContent = `Con ${fmt(wh)} Wh y ${fmt(totalW)} W simult√°neos.`;
				} else if (wh>0 && totalW===0){
					el.runtimeChip.textContent = '‚Äî';
					el.runtimeNote.textContent = 'Selecciona equipos para calcular horas simult√°neas.';
				} else {
					el.runtimeChip.textContent = '‚Äî';
					el.runtimeNote.textContent = 'Ingresa energ√≠a disponible para calcular horas.';
				}

						// Pico de arranque
						const mode = state.surgeMode || 'none';
						const factor = Math.max(1, Number(state.surgeFactor)||3);
						let peakW = totalW;
						if (mode !== 'none' && motorContrib.length){
							const extraPerUnit = motorContrib.map(w => w*(factor-1));
							const extra = mode==='all' ? extraPerUnit.reduce((a,b)=>a+b,0) : Math.max(...extraPerUnit);
							peakW = totalW + extra;
						}
						// UI pico
						const pctPeak = utilW>0? clamp(Math.round((peakW/utilW)*100), 0, 999) : 0;
						const bar2 = el.surgeProgress && el.surgeProgress.querySelector('span');
						if (bar2) {
							el.surgeProgress.dataset.state = pctPeak<85? 'ok' : (pctPeak<=100? 'warn' : 'danger');
							bar2.style.width = `${clamp(pctPeak,0,100)}%`;
						}
						if (el.surgeDetail) {
							el.surgeDetail.textContent = `${fmt(peakW)} W de ${fmt(utilW)} W disponibles` + (mode==='none'?' (pico desactivado)':'');
						}

				// Actualizar "M√°x con planta" por fila seg√∫n preset actual
				document.querySelectorAll('.t-row').forEach(row => {
					const id = row.dataset.id; const cfg = state.devices[id]; const item = findItemById(id);
					if (!item || !cfg) return;
					const watt = item.presets[cfg.preset];
					const maxUnits = utilW>0? Math.floor(utilW / watt) : 0;
					row.querySelector('.max .muted').textContent = `M√°x con planta: ${fmt(maxUnits)}`;
					const used = watt * (Number(cfg.qty)||0);
					row.querySelector('.watt .chip').textContent = `${fmt(used)} W`;
				});

						// Estado final con pico
						if (utilW<=0) {
							el.statusChip.textContent = 'Configura tu planta';
							el.statusChip.className = 'chip';
						} else {
							const withinRun = totalW<=utilW;
							const withinPeak = peakW<=utilW;
							if (withinRun && withinPeak) {
								el.statusChip.textContent = (state.surgeMode==='none')? 'Dentro del l√≠mite' : 'Dentro del l√≠mite (incl. pico)';
								el.statusChip.className = 'chip success';
							} else if (!withinRun) {
								el.statusChip.textContent = 'Exceso de potencia continua';
								el.statusChip.className = 'chip danger';
							} else {
								el.statusChip.textContent = 'Pico de arranque excedido';
								el.statusChip.className = 'chip danger';
							}
						}
			}

			function findItemById(id){
				for (const g of DEFAULT_DEVICES){ for (const it of g.items){ if (it.id===id) return it; } }
				if (state.custom){ for (const it of state.custom){ if (it.id===id) return it; } }
				return null;
			}

			function renderAll(){
				// Inputs principales
				el.plantPower.value = state.plantPower ?? 600;
				el.energyValue.value = state.energyValue ?? 2;
				el.energyUnit.value = state.energyUnit ?? 'kWh';
				el.safety.value = state.safety ?? 80;
						el.surgeMode.value = state.surgeMode ?? 'none';
						el.surgeFactor.value = state.surgeFactor ?? 3;

				// Eventos una sola vez
				if (!eventsAttached) {
					el.plantPower.addEventListener('input', () => { state.plantPower = Number(el.plantPower.value)||0; saveState(); recalc(); });
					el.energyValue.addEventListener('input', () => { state.energyValue = Number(el.energyValue.value)||0; saveState(); recalc(); });
					el.energyUnit.addEventListener('change', () => { state.energyUnit = el.energyUnit.value; saveState(); recalc(); });
					el.safety.addEventListener('input', () => { state.safety = clamp(Number(el.safety.value)||80,1,100); saveState(); recalc(); });
					el.surgeMode.addEventListener('change', () => { state.surgeMode = el.surgeMode.value; saveState(); recalc(); });
					el.surgeFactor.addEventListener('input', () => { state.surgeFactor = Math.max(1, Number(el.surgeFactor.value)||3); saveState(); recalc(); });
					eventsAttached = true;
				}
				
				renderDevices();
				recalc();
			}

			// Perfiles
			function applyProfile(name){
				// Reset cantidades pero preservar configuraci√≥n de motor
				for (const key of Object.keys(state.devices)) { 
					if (state.devices[key]) {
						state.devices[key].qty = 0; 
					}
				}
				const set = (id, qty, preset='med') => { 
					const item = findItemById(id);
					if (!item) return;
					const existingMotor = (state.devices[id] && Object.prototype.hasOwnProperty.call(state.devices[id],'motor')) ? state.devices[id].motor : !!item.motor;
					state.devices[id] = { preset, qty, motor: existingMotor }; 
				};
				if (name==='essential'){
					set('led', 6, 'med');
					set('router', 1, 'med');
					set('phone', 2, 'med');
					set('laptop', 1, 'med');
					set('fridge', 1, 'med');
					set('fan', 1, 'med');
				} else if (name==='full'){
					set('led', 10, 'med');
					set('router', 1, 'med');
					set('switch', 1, 'med');
					set('tv', 1, 'med');
					set('monitor', 1, 'med');
					set('pc', 1, 'med');
					set('laptop', 1, 'med');
					set('fridge', 1, 'med');
					set('fan', 2, 'med');
					set('wash', 1, 'med');
					set('micro', 0, 'med');
				}
				saveState();
				renderDevices();
				recalc();
			}
			// Event listeners de perfiles (una sola vez)
			if (!window.profileListenersAttached) {
				document.getElementById('profileEssential').addEventListener('click', ()=>applyProfile('essential'));
				document.getElementById('profileFull').addEventListener('click', ()=>applyProfile('full'));
				document.getElementById('profileClear').addEventListener('click', ()=>{ 
					for (const k of Object.keys(state.devices)) {
						if (state.devices[k]) {
							state.devices[k].qty = 0;
						}
					}
					saveState(); renderDevices(); recalc(); 
				});

				// Agregar personalizados
				document.getElementById('addCustom').addEventListener('click', () => {
				const name = document.getElementById('customName').value.trim();
						const icon = document.getElementById('customIcon').value.trim() || 'üß©';
						const motor = !!document.getElementById('customMotor').checked;
				const min = Number(document.getElementById('customMin').value)||0;
				const med = Number(document.getElementById('customMed').value)||0;
				const max = Number(document.getElementById('customMax').value)||0;
				if (!name || min<=0 || med<=0 || max<=0) { alert('Completa nombre y valores mayores a 0.'); return; }
				const id = 'c_' + Math.random().toString(36).slice(2,9);
						const item = { id, name, icon, motor, presets: {min, med, max} };
				state.custom = state.custom || []; state.custom.push(item);
				// Registrar config por defecto
						state.devices[id] = { preset: 'med', qty: 0, motor };
				saveState();
				// limpiar
				document.getElementById('customName').value = '';
						document.getElementById('customIcon').value = '';
						document.getElementById('customMotor').checked = false;
				document.getElementById('customMin').value = '';
				document.getElementById('customMed').value = '';
				document.getElementById('customMax').value = '';
					renderDevices();
					recalc();
				});
				window.profileListenersAttached = true;
			}

			// Iniciar
			renderAll();
		</script>
	</body>
</html>
